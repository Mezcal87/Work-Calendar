<!DOCTYPE html>

<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calendario Lavoro</title>

    <!-- Librerie per export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 { font-size: 24px; color: #333; margin-bottom: 15px; }

        .totale {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 15px;
            color: white;
        }

        .totale-label { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
        .totale-importo { font-size: 36px; font-weight: bold; }

        .container { max-width: 500px; margin: 20px auto; padding: 0 15px; }

        .nav-mese {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        .mese-corrente { font-size: 18px; font-weight: 600; color: #333; }

        .calendario {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .giorni-settimana {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .giorno-settimana {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            padding: 5px;
        }

        .griglia-giorni {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .giorno {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            background: #f8f9fa;
            transition: all 0.2s;
        }

        .giorno.altro-mese { opacity: 0.3; pointer-events: none; }
        .giorno.oggi { border: 2px solid #667eea; }
        
        .giorno.lavorato {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .giorno.weekend-lavorato {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: bold;
        }

        .giorno.custom-lavorato {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-weight: bold;
        }

        .giorno-numero { font-size: 16px; }
        .giorno-importo { font-size: 10px; margin-top: 2px; }

        .voice-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            margin-bottom: 10px;
        }

        .btn-voice { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .btn-export { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .btn-stats { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-confronto { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-backup { background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%); }

        .voice-status {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
            text-align: center;
            min-height: 20px;
        }

        .voice-status.listening {
            background: #fee140;
            color: #333;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-btns {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
        }

        .btn-70 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-85 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-altro { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }

        .custom-input { margin-bottom: 15px; }

        .custom-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .modal-actions { display: flex; gap: 10px; margin-top: 10px; }

        .btn-conferma {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-elimina {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }

        .btn-annulla {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: #666;
            background: #f0f0f0;
        }

        /* Export modal */
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .export-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .export-copia { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .export-giorni { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .export-pdf { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .export-excel { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }

        /* Stats modal */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }

        .stat-card-label { font-size: 12px; opacity: 0.9; margin-bottom: 5px; }
        .stat-card-value { font-size: 24px; font-weight: bold; }

        /* Confronto in modal */
        .confronto-modal {
            margin-top: 15px;
        }

        .confronto-modal h4 {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .mese-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .mese-nome { color: #666; font-size: 14px; font-weight: 500; }
        .mese-totale { color: #667eea; font-weight: bold; font-size: 16px; }
    </style>

</head>
<body>
    <div class="header">
        <h1>üí∞ Calendario Lavoro</h1>
        <div class="totale">
            <div class="totale-label">Totale mese</div>
            <div class="totale-importo" id="totale">0‚Ç¨</div>
        </div>
    </div>

    <div class="container">
        <div class="nav-mese">
            <button class="nav-btn" onclick="cambioMese(-1)">‚Üê</button>
            <div class="mese-corrente" id="meseCorrente"></div>
            <button class="nav-btn" onclick="cambioMese(1)">‚Üí</button>
        </div>

        <div class="calendario">
            <div class="giorni-settimana">
                <div class="giorno-settimana">Dom</div>
                <div class="giorno-settimana">Lun</div>
                <div class="giorno-settimana">Mar</div>
                <div class="giorno-settimana">Mer</div>
                <div class="giorno-settimana">Gio</div>
                <div class="giorno-settimana">Ven</div>
                <div class="giorno-settimana">Sab</div>
            </div>
            <div class="griglia-giorni" id="grigliaGiorni"></div>
        </div>

        <div class="voice-section">
            <button class="btn btn-voice" onclick="avviaVoce()">üé§ Aggiungi con voce</button>
            <button class="btn btn-stats" onclick="apriStats()">üìä Statistiche</button>
            <button class="btn btn-confronto" onclick="apriConfronto()">üìà Confronto mesi</button>
            <button class="btn btn-export" onclick="apriExport()">üì§ Condividi/Esporta</button>
            <button class="btn btn-backup" onclick="apriBackup()">üíæ Backup/Importa</button>
            <div id="voiceStatus" class="voice-status"></div>
        </div>
    </div>

    <!-- Modal giornata -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader"></div>
            
            <div class="modal-btns">
                <button class="modal-btn btn-70" onclick="aggiungiImporto(70)">70‚Ç¨</button>
                <button class="modal-btn btn-85" onclick="aggiungiImporto(85)">85‚Ç¨</button>
                <button class="modal-btn btn-altro" onclick="mostraCustom()">Altro</button>
            </div>

            <div class="custom-input" id="customInput" style="display:none;">
                <input type="number" id="importoCustom" placeholder="Importo ‚Ç¨" step="0.01">
            </div>

            <div class="modal-actions" id="modalActions">
                <button class="btn-annulla" onclick="chiudiModal()">Annulla</button>
                <button class="btn-conferma" id="btnConferma" onclick="confermaCustom()" style="display:none;">Conferma</button>
            </div>
            
            <div class="modal-actions" id="modalActionsElimina" style="display:none;">
                <button class="btn-annulla" onclick="chiudiModal()">Annulla</button>
                <button class="btn-elimina" onclick="eliminaGiornata()">Elimina</button>
            </div>
        </div>
    </div>

    <!-- Modal export -->
    <div class="modal" id="modalExport">
        <div class="modal-content">
            <div class="modal-header">üì§ Condividi/Esporta</div>
            
            <div class="export-options">
                <button class="export-btn export-copia" onclick="copiaRiepilogo()">
                    üìã Copia testo completo
                </button>
                <button class="export-btn export-giorni" onclick="copiaSoloGiorni()">
                    üìÖ Copia solo giorni
                </button>
                <button class="export-btn export-pdf" onclick="esportaPDF()">
                    üìÑ Scarica PDF
                </button>
                <button class="export-btn export-excel" onclick="esportaExcel()">
                    üìä Scarica Excel
                </button>
            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn-annulla" onclick="chiudiExport()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Modal statistiche -->
    <div class="modal" id="modalStats">
        <div class="modal-content">
            <div class="modal-header">üìä Statistiche Mese</div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-label">Giorni lavorati</div>
                    <div class="stat-card-value" id="statGiorni">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Media/giorno</div>
                    <div class="stat-card-value" id="statMedia">0‚Ç¨</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stat-card-label">Infrasettimanali</div>
                    <div class="stat-card-value" id="statInfra">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <div class="stat-card-label">Weekend</div>
                    <div class="stat-card-value" id="statWeekend">0</div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-annulla" onclick="chiudiStats()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Modal confronto -->
    <div class="modal" id="modalConfronto">
        <div class="modal-content">
            <div class="modal-header">üìà Confronto Mesi</div>
            
            <div class="confronto-modal">
                <h4>Ultimi 3 mesi</h4>
                <div id="confrontoContent"></div>
            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn-annulla" onclick="chiudiConfronto()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Modal backup -->
    <div class="modal" id="modalBackup">
        <div class="modal-content">
            <div class="modal-header">üíæ Backup/Importa</div>
            
            <div class="export-options">
                <button class="export-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="esportaBackup()">
                    üì• Scarica Backup
                </button>
                <button class="export-btn" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);" onclick="document.getElementById('fileInput').click()">
                    üì§ Importa Backup
                </button>
                <input type="file" id="fileInput" accept=".json" style="display:none;" onchange="importaBackup(event)">
            </div>

            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 10px; font-size: 13px; color: #856404;">
                ‚ö†Ô∏è Il backup salva tutti i tuoi dati. Conservalo al sicuro!
            </div>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn-annulla" onclick="chiudiBackup()">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        let giornate = {};
        let meseCorrente = new Date();
        let giornoSelezionato = null;
        let recognition = null;
        let isListening = false;

        window.addEventListener('load', () => {
            caricaDati();
            inizializzaVoce();
            renderCalendario();
        });

        function caricaDati() {
            const dati = localStorage.getItem('giornate_calendario');
            if (dati) giornate = JSON.parse(dati);
        }

        function salvaDati() {
            localStorage.setItem('giornate_calendario', JSON.stringify(giornate));
        }

        function renderCalendario() {
            const anno = meseCorrente.getFullYear();
            const mese = meseCorrente.getMonth();
            
            const nomiMesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                             'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('meseCorrente').textContent = nomiMesi[mese] + ' ' + anno;
            
            const primoGiorno = new Date(anno, mese, 1).getDay();
            const giorniMese = new Date(anno, mese + 1, 0).getDate();
            
            const griglia = document.getElementById('grigliaGiorni');
            griglia.innerHTML = '';
            
            for (let i = 0; i < primoGiorno; i++) {
                const div = document.createElement('div');
                div.className = 'giorno altro-mese';
                griglia.appendChild(div);
            }
            
            const oggi = new Date();
            const oggiStr = oggi.toISOString().split('T')[0];
            
            for (let giorno = 1; giorno <= giorniMese; giorno++) {
                const dataStr = anno + '-' + String(mese + 1).padStart(2, '0') + '-' + String(giorno).padStart(2, '0');
                
                const div = document.createElement('div');
                div.className = 'giorno';
                
                if (dataStr === oggiStr) div.classList.add('oggi');
                
                if (giornate[dataStr]) {
                    const tipo = giornate[dataStr].tipo;
                    if (tipo === 'weekend') div.classList.add('weekend-lavorato');
                    else if (tipo === 'custom') div.classList.add('custom-lavorato');
                    else div.classList.add('lavorato');
                    
                    div.innerHTML = '<div class="giorno-numero">' + giorno + '</div><div class="giorno-importo">' + giornate[dataStr].importo + '‚Ç¨</div>';
                } else {
                    div.innerHTML = '<div class="giorno-numero">' + giorno + '</div>';
                }
                
                div.onclick = () => apriModal(dataStr);
                griglia.appendChild(div);
            }
            
            aggiornaTotale();
            aggiornaStatistiche();
        }

        function cambioMese(dir) {
            meseCorrente.setMonth(meseCorrente.getMonth() + dir);
            renderCalendario();
        }

        function aggiornaTotale() {
            const anno = meseCorrente.getFullYear();
            const mese = meseCorrente.getMonth();
            let totale = 0;
            
            Object.keys(giornate).forEach(dataStr => {
                const data = new Date(dataStr + 'T12:00:00');
                if (data.getFullYear() === anno && data.getMonth() === mese) {
                    totale += giornate[dataStr].importo;
                }
            });
            
            document.getElementById('totale').textContent = totale.toFixed(2) + '‚Ç¨';
        }

        function aggiornaStatistiche() {
            const anno = meseCorrente.getFullYear();
            const mese = meseCorrente.getMonth();
            
            let giorni = 0;
            let totale = 0;
            let infraCount = 0;
            let infraTotale = 0;
            let weekendCount = 0;
            let weekendTotale = 0;
            
            Object.keys(giornate).forEach(dataStr => {
                const data = new Date(dataStr + 'T12:00:00');
                if (data.getFullYear() === anno && data.getMonth() === mese) {
                    giorni++;
                    totale += giornate[dataStr].importo;
                    
                    if (giornate[dataStr].tipo === 'weekend') {
                        weekendCount++;
                        weekendTotale += giornate[dataStr].importo;
                    } else if (giornate[dataStr].tipo === 'infrasettimanale') {
                        infraCount++;
                        infraTotale += giornate[dataStr].importo;
                    }
                }
            });
            
            const media = giorni > 0 ? (totale / giorni) : 0;
            
            document.getElementById('statGiorni').textContent = giorni;
            document.getElementById('statMedia').textContent = media.toFixed(0) + '‚Ç¨';
            document.getElementById('statInfra').textContent = infraCount + ' (' + infraTotale.toFixed(0) + '‚Ç¨)';
            document.getElementById('statWeekend').textContent = weekendCount + ' (' + weekendTotale.toFixed(0) + '‚Ç¨)';
        }

        function apriStats() {
            aggiornaStatistiche();
            document.getElementById('modalStats').classList.add('show');
        }

        function chiudiStats() {
            document.getElementById('modalStats').classList.remove('show');
        }

        function apriConfronto() {
            aggiornaConfronto();
            document.getElementById('modalConfronto').classList.add('show');
        }

        function chiudiConfronto() {
            document.getElementById('modalConfronto').classList.remove('show');
        }

        // ============================================
        // BACKUP / IMPORT
        // ============================================

        function apriBackup() {
            document.getElementById('modalBackup').classList.add('show');
        }

        function chiudiBackup() {
            document.getElementById('modalBackup').classList.remove('show');
        }

        function esportaBackup() {
            const backup = {
                version: '1.0',
                data: giornate,
                exportDate: new Date().toISOString(),
                totalDays: Object.keys(giornate).length
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'calendario-backup-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostraFeedback('‚úì Backup scaricato!');
            chiudiBackup();
        }

        function importaBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.data) {
                        alert('File backup non valido!');
                        return;
                    }
                    
                    if (confirm('Importare ' + Object.keys(backup.data).length + ' giornate?\n\nATTENZIONE: I dati attuali verranno sovrascritti!')) {
                        giornate = backup.data;
                        salvaDati();
                        renderCalendario();
                        mostraFeedback('‚úì Backup importato!');
                        chiudiBackup();
                    }
                } catch (err) {
                    alert('Errore nel file backup!');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function aggiornaConfronto() {
            const oggi = new Date();
            const mesi = [];
            
            for (let i = 0; i < 3; i++) {
                const data = new Date(oggi.getFullYear(), oggi.getMonth() - i, 1);
                mesi.push(data);
            }
            
            const nomiMesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                             'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            let html = '';
            
            mesi.forEach(data => {
                const anno = data.getFullYear();
                const mese = data.getMonth();
                let totale = 0;
                
                Object.keys(giornate).forEach(dataStr => {
                    const d = new Date(dataStr + 'T12:00:00');
                    if (d.getFullYear() === anno && d.getMonth() === mese) {
                        totale += giornate[dataStr].importo;
                    }
                });
                
                html += '<div class="mese-row">';
                html += '<div class="mese-nome">' + nomiMesi[mese] + ' ' + anno + '</div>';
                html += '<div class="mese-totale">' + totale.toFixed(2) + '‚Ç¨</div>';
                html += '</div>';
            });
            
            document.getElementById('confrontoContent').innerHTML = html;
        }

        function apriModal(dataStr) {
            giornoSelezionato = dataStr;
            const data = new Date(dataStr + 'T12:00:00');
            const giorno = data.getDate();
            const nomiMesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                             'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            if (giornate[dataStr]) {
                document.getElementById('modalHeader').textContent = giorno + ' ' + nomiMesi[data.getMonth()] + ' - ' + giornate[dataStr].importo + '‚Ç¨';
                document.getElementById('modalActions').style.display = 'none';
                document.getElementById('modalActionsElimina').style.display = 'flex';
            } else {
                document.getElementById('modalHeader').textContent = 'Aggiungi ' + giorno + ' ' + nomiMesi[data.getMonth()];
                document.getElementById('modalActions').style.display = 'flex';
                document.getElementById('modalActionsElimina').style.display = 'none';
            }
            
            document.getElementById('customInput').style.display = 'none';
            document.getElementById('btnConferma').style.display = 'none';
            document.getElementById('importoCustom').value = '';
            document.getElementById('modal').classList.add('show');
        }

        function chiudiModal() {
            document.getElementById('modal').classList.remove('show');
            giornoSelezionato = null;
        }

        function mostraCustom() {
            document.getElementById('customInput').style.display = 'block';
            document.getElementById('btnConferma').style.display = 'block';
            document.getElementById('importoCustom').focus();
        }

        function aggiungiImporto(importo) {
            if (!giornoSelezionato) return;
            let tipo = importo === 85 ? 'weekend' : 'infrasettimanale';
            giornate[giornoSelezionato] = { importo, tipo };
            salvaDati();
            renderCalendario();
            chiudiModal();
            mostraFeedback('‚úì Aggiunto!');
        }

        function confermaCustom() {
            if (!giornoSelezionato) return;
            const importo = parseFloat(document.getElementById('importoCustom').value);
            if (!importo || importo <= 0) {
                alert('Importo non valido!');
                return;
            }
            giornate[giornoSelezionato] = { importo, tipo: 'custom' };
            salvaDati();
            renderCalendario();
            chiudiModal();
            mostraFeedback('‚úì Aggiunto!');
        }

        function eliminaGiornata() {
            if (!giornoSelezionato) return;
            delete giornate[giornoSelezionato];
            salvaDati();
            renderCalendario();
            chiudiModal();
            mostraFeedback('‚úì Eliminato!');
        }

        function mostraFeedback(msg) {
            const status = document.getElementById('voiceStatus');
            status.textContent = msg;
            status.style.background = '#4caf50';
            status.style.color = 'white';
            status.classList.remove('listening');
            setTimeout(() => {
                status.textContent = '';
                status.style.background = '#f0f0f0';
                status.style.color = '#666';
            }, 2000);
        }

        // ============================================
        // EXPORT
        // ============================================

        function apriExport() {
            document.getElementById('modalExport').classList.add('show');
        }

        function chiudiExport() {
            document.getElementById('modalExport').classList.remove('show');
        }

        function copiaRiepilogo() {
            const anno = meseCorrente.getFullYear();
            const mese = meseCorrente.getMonth();
            const nomiMesi = ['GENNAIO', 'FEBBRAIO', 'MARZO', 'APRILE', 'MAGGIO', 'GIUGNO',
                             'LUGLIO', 'AGOSTO', 'SETTEMBRE', 'OTTOBRE', 'NOVEMBRE', 'DICEMBRE'];
            const giorni = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            
            const lista = [];
            let totale = 0;
            
            Object.keys(giornate).forEach(dataStr => {
                const data = new Date(dataStr + 'T12:00:00');
                if (data.getFullYear() === anno && data.getMonth() === mese) {
                    lista.push({ data: data, importo: giornate[dataStr].importo });
                    totale += giornate[dataStr].importo;
                }
            });
            
            lista.sort((a, b) => a.data - b.data);
            
            let testo = 'üìÖ ' + nomiMesi[mese] + ' ' + anno + '\n\n';
            
            if (lista.length === 0) {
                testo += 'Nessuna giornata lavorata\n';
            } else {
                lista.forEach(g => {
                    const gg = giorni[g.data.getDay()];
                    const num = g.data.getDate();
                    const mm = nomiMesi[g.data.getMonth()].slice(0, 3);
                    testo += gg + ' ' + num + ' ' + mm.charAt(0) + mm.slice(1).toLowerCase() + ' - ' + g.importo.toFixed(2) + '‚Ç¨\n';
                });
            }
            
            testo += '\nüí∞ TOTALE: ' + totale.toFixed(2) + '‚Ç¨';
            
            const textarea = document.createElement('textarea');
            textarea.value = testo;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                mostraFeedback('‚úì Copiato!');
                chiudiExport();
            } catch (err) {
                mostraFeedback('‚ùå Errore');
            }
            
            document.body.removeChild(textarea);
        }

        function copiaSoloGiorni() {
            const anno = meseCorrente.getFullYear();
            const mese = meseCorrente.getMonth();
            const nomiMesi = ['GENNAIO', 'FEBBRAIO', 'MARZO', 'APRILE', 'MAGGIO', 'GIUGNO',
                             'LUGLIO', 'AGOSTO', 'SETTEMBRE', 'OTTOBRE', 'NOVEMBRE', 'DICEMBRE'];
            const giorni = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            
            const lista = [];
            
            Object.keys(giornate).forEach(dataStr => {
                const data = new Date(dataStr + 'T12:00:00');
                if (data.getFullYear() === anno && data.getMonth() === mese) {
                    lista.push({ data: data });
                }
            });
            
            lista.sort((a, b) => a.data - b.data);
            
            let testo = 'üìÖ ' + nomiMesi[mese] + ' ' + anno + '\n\n';
            
            if (lista.length === 0) {
                testo += 'Nessuna giornata lavorata\n';
            } else {
                lista.forEach(g => {
                    const gg = giorni[g.data.getDay()];
                    const num = g.data.getDate();
                    const mm = nomiMesi[g.data.getMonth()].slice(0, 3);
                    testo += gg + ' ' + num + ' ' + mm.charAt(0) + mm.slice(1).toLowerCase() + '\n';
                });
            }
            
            const textarea = document.createElement('textarea');
            textarea.value = testo;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                mostraFeedback('‚úì Giorni copiati!');
                chiudiExport();
            } catch (err) {
                mostraFeedback('‚ùå Errore');
            }
            
            document.body.removeChild(textarea);
        }

        function esportaPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const anno = meseCorrente.getFullYear();
            const mese = meseCorrente.getMonth();
            const nomiMesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                             'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            doc.setFontSize(20);
            doc.text('Calendario Lavoro', 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.text(nomiMesi[mese] + ' ' + anno, 105, 35, { align: 'center' });
            
            const lista = [];
            let totale = 0;
            
            Object.keys(giornate).forEach(dataStr => {
                const data = new Date(dataStr + 'T12:00:00');
                if (data.getFullYear() === anno && data.getMonth() === mese) {
                    lista.push({ data: data, importo: giornate[dataStr].importo });
                    totale += giornate[dataStr].importo;
                }
            });
            
            lista.sort((a, b) => a.data - b.data);
            
            doc.setFontSize(12);
            let y = 50;
            
            lista.forEach(g => {
                const dataStr = g.data.getDate() + '/' + (g.data.getMonth() + 1) + '/' + g.data.getFullYear();
                doc.text(dataStr, 20, y);
                doc.text(g.importo.toFixed(2) + ' EUR', 170, y);
                y += 10;
                
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
            });
            
            doc.setFontSize(14);
            doc.text('TOTALE: ' + totale.toFixed(2) + ' EUR', 105, y + 10, { align: 'center' });
            
            doc.save('calendario-' + nomiMesi[mese].toLowerCase() + '-' + anno + '.pdf');
            mostraFeedback('‚úì PDF scaricato!');
            chiudiExport();
        }

        function esportaExcel() {
            const anno = meseCorrente.getFullYear();
            const mese = meseCorrente.getMonth();
            const nomiMesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                             'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            const data = [['Data', 'Importo (‚Ç¨)']];
            let totale = 0;
            
            const lista = [];
            Object.keys(giornate).forEach(dataStr => {
                const d = new Date(dataStr + 'T12:00:00');
                if (d.getFullYear() === anno && d.getMonth() === mese) {
                    lista.push({ data: d, importo: giornate[dataStr].importo });
                    totale += giornate[dataStr].importo;
                }
            });
            
            lista.sort((a, b) => a.data - b.data);
            
            lista.forEach(g => {
                const dataStr = g.data.getDate() + '/' + (g.data.getMonth() + 1) + '/' + g.data.getFullYear();
                data.push([dataStr, g.importo]);
            });
            
            data.push(['', '']);
            data.push(['TOTALE', totale]);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, nomiMesi[mese]);
            
            XLSX.writeFile(wb, 'calendario-' + nomiMesi[mese].toLowerCase() + '-' + anno + '.xlsx');
            mostraFeedback('‚úì Excel scaricato!');
            chiudiExport();
        }

        // ============================================
        // VOICE - N8N + GROQ WHISPER
        // ============================================

        const WEBHOOK_URL = 'https://n8n.srv1141198.hstgr.cloud/webhook/calendario-voce';
        let mediaRecorder = null;
        let audioChunks = [];

        function inizializzaVoce() {
            // Verifica supporto MediaRecorder
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                document.querySelector('.btn-voice').style.display = 'none';
                return;
            }
        }

        async function avviaVoce() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // Ferma registrazione
                fermaRegistrazione();
                return;
            }

            try {
                // Richiedi permesso microfono
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    // Crea blob audio
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // Invia a N8N
                    await inviaAudioAN8N(audioBlob);
                    
                    // Ferma stream
                    stream.getTracks().forEach(track => track.stop());
                };

                // Avvia registrazione
                mediaRecorder.start();
                
                const status = document.getElementById('voiceStatus');
                status.textContent = 'üé§ Registrando... (tocca per fermare)';
                status.classList.add('listening');
                
                document.querySelector('.btn-voice').textContent = '‚èπÔ∏è Ferma';

            } catch (err) {
                console.error('Errore microfono:', err);
                mostraFeedback('‚ùå Permesso microfono negato');
            }
        }

        function fermaRegistrazione() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.querySelector('.btn-voice').textContent = 'üé§ Aggiungi con voce';
                
                const status = document.getElementById('voiceStatus');
                status.textContent = '‚è≥ Elaborando...';
                status.classList.remove('listening');
            }
        }

        async function inviaAudioAN8N(audioBlob) {
            try {
                // Converti blob in base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                
                reader.onloadend = async () => {
                    const base64Audio = reader.result.split(',')[1];
                    
                    // Invia a N8N
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            audio: base64Audio
                        })
                    });

                    const risultato = await response.json();
                    
                    if (risultato.successo && risultato.giornate && risultato.giornate.length > 0) {
                        // Aggiungi tutte le giornate riconosciute
                        risultato.giornate.forEach(g => {
                            giornate[g.data] = {
                                importo: g.importo,
                                tipo: g.tipo
                            };
                        });
                        
                        salvaDati();
                        renderCalendario();
                        mostraFeedback(`‚úì Aggiunte ${risultato.giornate.length} giornate!`);
                        
                        // Mostra trascrizione
                        if (risultato.trascrizione) {
                            setTimeout(() => {
                                document.getElementById('voiceStatus').textContent = `"${risultato.trascrizione}"`;
                            }, 2000);
                        }
                    } else {
                        mostraFeedback('‚ùå Non ho capito. Riprova!');
                        if (risultato.trascrizione) {
                            document.getElementById('voiceStatus').textContent = `Hai detto: "${risultato.trascrizione}"`;
                        }
                    }
                };
            } catch (err) {
                console.error('Errore invio audio:', err);
                mostraFeedback('‚ùå Errore connessione');
            }
        }
    </script>

</body>
</html>
